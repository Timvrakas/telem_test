<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Telem_Test</title>

	<script language="javascript" type="text/javascript" src="jquery.flot.js"></script>
	<script type="text/javascript">

		$(function () {

			// We use an inline data source in the example, usually data would
			// be fetched from a server

			nums = []

			$.ajax({
				type: "POST",
				url: "http://localhost:8000/register",
				contentType: "application/json",
				data: JSON.stringify({ "user_id": 1 })
			}).done(function (data, textStatus, jqXHR) {
				url = 'ws://localhost:8000/ws/' + data.uuid;
				console.log(url)
				webSocket = new WebSocket(url);
				webSocket.onmessage = function (event) {
					parsed = JSON.parse(event.data)
					if ("sensor.tick" in parsed) {
						x = parsed["sensor.bmi1.a.0"]
						t = parsed["sensor.tick"] + 1603954948000;
						nums.push([t, x])
						if (nums.length > 1000) {
							nums.splice(0, 1)
						}
						$("#result").text(t)
					}

				}
			});

			var updateInterval = 30;

			var plot = $.plot("#placeholder", nums, {
					// xaxes: [
					//  	{ position: 'bottom', autoScale: 'none', min: 0.0, max: 15000.0 }
					//  ]
					// // yaxes: [
						
					// ],
					// zoom: {
					// 	interactive: true
					// },
					// pan: {
					// 	interactive: true
					// }
				});

			function update() {

				var now = new Date().getTime();
				var start = now - 10000;

				plot.getOptions().xaxes[0].min = start;
				plot.getOptions().xaxes[0].max = now;
				plot.setData([nums]);
				plot.setupGrid();
				
				$("#time").text(now)


				
				// Since the axes don't change, we don't need to call plot.setupGrid()




				
				



				plot.draw();
				plot.setupGrid(true)
				setTimeout(update, updateInterval);
			}

			update();

		});

	</script>
</head>

<body>
	<h2>This is a Telem Test</h2>
	<div id="placeholder" style="width:600px;height:300px"></div>
	<div id="result"></div>
	<div id="time"></div>
</body>

</html>